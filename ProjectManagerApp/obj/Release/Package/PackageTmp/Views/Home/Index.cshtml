@using Microsoft.AspNet.Identity
@model ProjectManagerApp.Models.DAL.Output.Projects

@{
    ViewBag.Title = "Home Page";
  
}

  
  
    @*@Scripts.Render("~/bundles/datetimepicker")*@


<h1>Logs Entry</h1>
    <div class="body-content">
        
            <div class="row">
                <div class="col-md-5">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="form-group">
                                <input type="text" style="height: 35px" id="description" placeholder="What have you done?" class="form-control"/>

                            </div>
                        </div>
                        <div class="col-md-5">

                            <div class="form-group">
                                @Html.DropDownListFor(model => model.Id, new SelectList(ViewBag.Projects, "id", "Name"), new { @class = "form-control", id = "dropdown" })

                            </div>


                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="input-group date" id='datetimepicker1'>
                                    <input type='text' class="form-control" id="workstartingtime"/>
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-time"></span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="input-group date" id='datetimepicker2'>
                                    <input type='text' class="form-control" id="workendingtime"/>
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-time"></span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <div class="form-group">
                                <input type="text" id="duration" style="height: 35px; width: 70px" placeholder="00:00" class="form-control"/>
                            </div>

                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="input-group date" id='datetimepicker3'>
                                    <input type='text' class="form-control" id="date" />
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-1">
                            <input type="button" id="addbutton" value="Add" class="btn btn-default" />
                        </div>
                    </div>
                </div>
            </div>
           
         
        </div>
    


<br/>
<div id="message"></div>
<br/>
<div id="head"></div>
<div id="temptable">
    <table id="logtable">
    
        <thead>
            <tr>
                <td>Description</td>
                <td>Project Name</td>
                <td>Duration</td>
                <td>Start Time</td>
                <td>End Time</td>
                <td>Date</td>
                <td></td>
                <td>Operation</td>
            </tr>
        </thead>
        <tbody>
          
        </tbody>
    </table>

    

  

</div>

<br />

<br/>
<br/>
<div class="row">
    <div class="col-md-5"></div>
    <div class="col-md-4"></div>
    <div class="col-md-2"></div>
    <div class="col-md-1">
        <div class="savebuttoncls">
          
        </div>
    </div>
</div>

<div id="message1"></div>



<script type="text/javascript">

        $('h2').hide();
        $('#savebutton').hide();
       
    $(document).ready(function () {
        $('#datetimepicker1').datetimepicker({
            format: 'h:mm a'

        });

    });
    $(document).ready(function () {
        $('#datetimepicker2').datetimepicker({
            format: 'h:mm a'

        });
    });
    $(document).ready(function(){
        $('#datetimepicker3').datetimepicker({
            format: 'YYYY-M-D',
          //  todayHighlight:true

        });
    });
    $('#logtable').hide();
    

    // for 20.10

    function ConvertTimeFormat(format, time) {

        //var time = $('#workstartingtime').val();
        var hours = Number(time.match(/^(\d+)/)[1]);
        var minutes = Number(time.match(/:(\d+)/)[1]);
        var AMPM = time.match(/\s(.*)$/)[1];
        if (AMPM == "pm" && hours < 12) hours = hours + 12;
        if (AMPM == "am" && hours == 12) hours = hours - 12;
        var sHours = hours.toString();
        var sMinutes = minutes.toFixed(2);
        if (hours < 10) sHours = "0" + sHours;
        if (minutes < 10) sMinutes = "0" + sMinutes;
        return (sHours + "." + sMinutes);
    };

        //for 20:10
    function ConvertTimeFormat1(format, time) {

        //var time1 = $('#workendingtime').val();
        var hours1 = Number(time.match(/^(\d+)/)[1]);
        var minutes1 = Number(time.match(/:(\d+)/)[1]);
        var AMPM1 = time.match(/\s(.*)$/)[1];
        if (AMPM1 == "pm" && hours1 < 12) hours1 = hours1 + 12;
        if (AMPM1 == "am" && hours1 == 12) hours1 = hours1 - 12;
        var sHours1 = hours1.toString();
        var sMinutes1 = minutes1.toFixed(2);
        if (hours1 < 10) sHours1 = "0" + sHours1;
        if (minutes1 < 10) sMinutes1 = "0" + sMinutes1;

        return (sHours1 + ":" + sMinutes1);
    };


    // function to check if workstartime is greater than workendtime

    $(document).ready(function () {
        $('#workendingtime').focusout(function () {
            var starttime = parseFloat(ConvertTimeFormat("24", $('#workstartingtime').val()));
            var endtime = parseFloat(ConvertTimeFormat("24", $('#workendingtime').val()));

            console.log("starttime",starttime);

            console.log("endtime",endtime);


            var workstime = starttime.toFixed(2).split('.');
            var worketime = endtime.toFixed(2).split('.');
            var shours = parseInt(workstime[0]);
            var sminute = parseInt(workstime[1]);
            var ehours = parseInt(worketime[0]);
            console.log(worketime[1]);
            var eminute = parseInt(worketime[1]);
          
            //alert("eminutes", eminute);
            //console.log(eminute);

            //if (isNaN(eminute)) {
            //    eminute = 0;
            //}
            var hdiff = ehours - shours;
            var mdiff = eminute - sminute;

            if (endtime > starttime) {
          

                //$('#duration').val(hdiff + ":" + mdiff);

                if (mdiff<0) {
                    mdiff = mdiff + 60;
                    hdiff = hdiff - 1;
                    $('#duration').val(hdiff + ":" + mdiff);
                }
               else {
                    $('#duration').val(hdiff + ":" + mdiff);
                }


            }


            else if (endtime == starttime && mdiff>=0) {
               var hdiff1 = 0;
                mdiff = eminute - sminute;
                $('#duration').val(hdiff1 + ":" + mdiff);
            }

            //else if (eminute==0)
            //{
            //    alert("wrong");
            //}

            else {
                alert("work finished time must be greater than work start time");
                $('#duration').val("00" + ":" + "00");
            }

        });

        $('#workstartingtime').focusout(function () {
            var starttime = parseFloat(ConvertTimeFormat("24", $('#workstartingtime').val()));
            var endtime = parseFloat(ConvertTimeFormat("24", $('#workendingtime').val()));

            console.log("starttime", starttime);

            console.log("endtime", endtime);


            var workstime = starttime.toFixed(2).split('.');
            var worketime = endtime.toFixed(2).split('.');
            var shours = parseInt(workstime[0]);
            var sminute = parseInt(workstime[1]);
            var ehours = parseInt(worketime[0]);
            console.log(worketime[1]);
            var eminute = parseInt(worketime[1]);

            //alert("eminutes", eminute);
            //console.log(eminute);

            //if (isNaN(eminute)) {
            //    eminute = 0;
            //}
            var hdiff = ehours - shours;
            var mdiff = eminute - sminute;

            if (endtime > starttime) {


                //$('#duration').val(hdiff + ":" + mdiff);

                if (mdiff < 0) {
                    mdiff = mdiff + 60;
                    hdiff = hdiff - 1;
                    $('#duration').val(hdiff + ":" + mdiff);
                }
                else {
                    $('#duration').val(hdiff + ":" + mdiff);
                }


            }


            else if (endtime == starttime && mdiff >= 0) {
                var hdiff1 = 0;
                mdiff = eminute - sminute;
                $('#duration').val(hdiff1 + ":" + mdiff);
            }

                //else if (eminute==0)
                //{
                //    alert("wrong");
                //}

            else {
                alert("work finished time must be greater than work start time");
                $('#duration').val("00" + ":" + "00");
            }

        });

    });

    var count = 0;

    $(document).ready(function () {
        $('#addbutton').click(function () {
      
            var description = $('#description').val();
            var name = $('#dropdown option:selected').text();
            var projectid = $("#dropdown option:selected").val();
            var duration = $('#duration').val();
            var workstime = $('#workstartingtime').val();
            var worketime = $('#workendingtime').val();
            var date = $('#date').val();

          //  alert(id);



        
           

            var report = "";

            if (description !== "" && name !== "" && duration !== "" && workstime !== "" && worketime !== "" && date !== "") {

                report += '<tr class="logrow">' +
                    '<td class="description">' + description + '</td>' +
                    '<td class="projectname">' + name + '<input type="hidden" class="projectid" value="' + projectid + '"/>' + '</td>' +
                    '<td class="duration">' + duration + '</td>' +
                    '<td class="workstime">' + workstime + '</td>' +
                    '<td class="worketime">' + worketime + '</td>' +
                    '<td class="date">' + date + '</td>' +
                    '<td class="developerid">'+'<input type="hidden" class="developerid" value="' + @HttpContext.Current.User.Identity.GetUserId() + '"/>'+'</td>'+
                    '<td>' +
                    '<input type="button" id="deletebutton" value="Delete"  onclick="operation(this);"/>' +
                    '</td>' +
                    '</tr>';
                    console.log(report);
                    $('#logtable').show();
                    $('#logtable').append(report);

                count++;

                $('#head').html('<h2>Logs</h2>');
                $('.savebuttoncls').html('<input type="button" id="savebutton" value="Save" class="btn btn-default" onclick="savebuttonclicked(this);" />');
                $('.alert-danger').hide();
                $('.alert-success').hide();
                reset();
            } else {
              
               $('#message').html('<div class="alert alert-danger">Fill out all the blanks!!</div>');
               $('.alert-success').hide();
            }
         
        });


    });


    // saving button clicked

    function savebuttonclicked(ob) {

       
        //fetching data from div by iteration and converting them to xml and json
        var html = new Array();
        html.push('<logs>');
        $.each($('#logtable tr.logrow'), function (index, rec) {
            var description = $($(rec).children('td.description')).html();
            var projectid = $($(rec).children('td.projectname').find('input[type=hidden].projectid')).val();
            var duration = $($(rec).children('td.duration')).html();
            var workstime = $($(rec).children('td.workstime')).html();
            var worketime = $($(rec).children('td.worketime')).html();
            var date = $($(rec).children('td.date')).html();
            var developerid = $($(rec).children('td.developerid').find('input[type=hidden].developerid')).val();
            html.push('<LineItem ');
            html.push('Description="' + description + '"');
            html.push('ProjectId="' + projectid + '"');
            html.push('Duration="' + duration + '"');
            html.push('WorkStartTime="' + workstime + '"');
            html.push('WorkEndTime="' + worketime + '"');
            html.push('Date="' + date + '"');
            html.push('DeveloperId="' + developerid + '"');
            html.push('></LineItem>');
            //console.log(projectid);
        });
        html.push('</logs>');
        console.log(html.join(''));
        var logXML = html.join(' ');
        // var json = sys.Serialization.JavaScriptSerializer.serialize(logXML);
        var json = '{"logXML":' + JSON.stringify(logXML) + '}';
        console.log(json);

        //to count the no of rows inside div
        // var count = $('#temptable .logrow').length;

        $.ajax({
            type: 'POST',
            url: '/API/Log/SaveReport',
            data: json,
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                // alert("Data Saved Successfully");

                // to empty temptable after saving records in database
                $('#temptable #logtable tbody').empty();
                $('#temptable #logtable').hide();
                // $('#temptable #logtable').find('tr:gt(0)').remove();
                $('#savebutton').hide();
                $('.alert-danger').hide();
                $('#message1').html('<div class="alert alert-success"> Log Record Saved Successfully </div>');
               
                $('h2').hide();
            },
            error: function () {
                // alert("something went wrong while  saving. try again!!");
                //$('.alert-warning').show();
                $('#message1').html('<div class="alert alert-danger">something went wrong while  saving. try again!!</div>');
            }
        });

    }

    //clearing the fields after adding
    function reset() {
        document.getElementById("description").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("date").value = "";
        document.getElementById("workstartingtime").value = "";
        document.getElementById("workendingtime").value = "";
    }

    
    //function for button to delete
    function operation(ob) {
        $(ob).parent().parent().remove();
    }

    // for deleting specific columns selected
    function editor(ob) {
        var option = ob.value;
        //alert(option);

        if (option == 1) {
            alert("Are you sure want to delete?");
            $(ob).parent().parent().parent().remove();
        }
    }


    // for highlighting specific checked column
    function check(obj) {
        // console.log("sasasasa",obj);
        $(obj).parent().parent().parent().toggleClass("highlight");
    }



</script>


<style>
    #logtable {
        border: 1px solid #666;
        width: 100%;
    }

    td {
        background: #f8f8f8;
        font-weight: bold;
        padding: 2px;
    }

    
     thead {
    background-color: #4CAF50;
      height:50px;
    color: black;
}

    .highlight {
        background-color: red;
    }
</style>

